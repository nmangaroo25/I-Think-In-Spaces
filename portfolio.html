<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Norris Mangaroo — Portfolio (Flipbook)</title>
  <style>
    :root{--bg:#0f1720;--card:#fff;--muted:#8892a6}
    html,body{height:100%;margin:0;font-family:Inter,Helvetica,Arial,sans-serif;background:var(--bg);color:#fff}
    a.back {position:fixed;left:18px;top:18px;background:#fff;color:#111;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600;z-index:9999}
    .topbar{position:fixed;right:18px;top:18px;display:flex;gap:8px;align-items:center;z-index:9999}
    .btn{background:#fff;color:#111;border:none;padding:8px 10px;border-radius:8px;font-weight:600;cursor:pointer}
    .pager{display:flex;gap:6px;align-items:center;background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px}
    #flipbook-wrap{height:100vh;display:flex;align-items:center;justify-content:center;padding:64px 24px;box-sizing:border-box}
    #flipbook{box-shadow:0 10px 30px rgba(2,6,23,0.7);background:transparent}
    .page{background:var(--card);overflow:hidden;display:flex;align-items:center;justify-content:center}
    #message{position:fixed;left:18px;bottom:18px;background:rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:var(--muted);font-size:13px;max-width:45%}
    #diag{position:fixed;right:18px;bottom:18px;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:8px;color:#ddd;font-size:12px;max-width:40%;max-height:36vh;overflow:auto}
    #diag b{color:#fff}
    @media (max-width:900px){
      .topbar{right:12px;gap:6px}
      a.back{left:12px;top:12px;padding:6px 10px}
      #message, #diag{max-width:80%}
    }
  </style>
</head>
<body>
  <a class="back" href="https://nmangaroo25.github.io/I-Think-In-Spaces/#home">← Back to Home</a>

  <div class="topbar" role="toolbar" aria-label="Flipbook controls">
    <div class="pager" title="Navigation">
      <button id="prev" class="btn" aria-label="Previous page">‹</button>
      <input id="pageNum" type="number" min="1" value="1" style="width:64px;padding:6px;border-radius:6px;border:none;font-weight:700" />
      <span id="pageTotal" style="color:var(--muted);font-weight:600;padding-left:6px">/ 0</span>
      <button id="next" class="btn" aria-label="Next page">›</button>
    </div>

    <div style="width:10px"></div>
    <div class="pager" title="View">
      <button id="zoomOut" class="btn" aria-label="Zoom out">−</button>
      <button id="zoomIn" class="btn" aria-label="Zoom in">＋</button>
    </div>

    <div style="width:10px"></div>
    <a id="download" class="btn" download>Download</a>
  </div>

  <div id="flipbook-wrap">
    <div id="flipbook" aria-live="polite" role="application" aria-label="Portfolio flipbook"></div>
  </div>

  <div id="message">Loading flipbook — if nothing appears within 6s, open your browser console or check the diagnostics panel (bottom-right).</div>
  <div id="diag"><b>Diagnostics:</b><br><ul id="log" style="padding-left:18px;margin:6px 0 0 0;color:#cbd5e1"></ul></div>

  <noscript>
    <div style="position:fixed;left:18px;bottom:64px;background:#fff;color:#111;padding:8px 12px;border-radius:8px">
      JavaScript required — <a href="Norris_Mangaroo_Arch_Portfolio.pdf" download>download the PDF</a>
    </div>
  </noscript>

  <script>
    // Robust script loader with fallbacks and diagnostics.
    const LOG = (msg) => {
      const ul = document.getElementById('log');
      const li = document.createElement('li');
      li.textContent = msg;
      ul.appendChild(li);
      console.log('[flipbook] ' + msg);
    };

    function loadScript(url, attrs = {}) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        for (const k in attrs) s.setAttribute(k, attrs[k]);
        s.onload = () => resolve(url);
        s.onerror = () => reject(new Error('Failed to load: ' + url));
        document.head.appendChild(s);
      });
    }

    async function tryUrls(name, urls, attrs) {
      for (const u of urls) {
        try {
          LOG(`Attempting ${name} from: ${u}`);
          await loadScript(u, attrs);
          LOG(`Loaded ${name} from: ${u}`);
          return u;
        } catch (err) {
          LOG(`Failed to load ${name} from: ${u}`);
        }
      }
      throw new Error(`${name} failed to load from all fallbacks`);
    }

    (async function main() {
      const jQueryUrls = [
        'https://code.jquery.com/jquery-3.6.0.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js',
        'https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js'
      ];

      const turnUrls = [
        'https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/turn.js/0.11/turn.min.js',
        'https://cdn.jsdelivr.net/npm/turn.js@4.1.0/turn.min.js'
      ];

      const pdfJsUrls = [
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js'
      ];

      // 1) load jQuery
      try {
        await tryUrls('jQuery', jQueryUrls);
      } catch (err) {
        document.getElementById('message').textContent = 'Error: jQuery failed to load from all CDNs. See diagnostics.';
        return;
      }

      // small delay to ensure $ binding (rare race)
      await new Promise(r=>setTimeout(r,50));

      // sanity
      if (typeof window.jQuery === 'undefined') {
        document.getElementById('message').textContent = 'Error: jQuery is not available after load attempts.';
        LOG('window.jQuery is undefined after attempted loads.');
        return;
      }

      // 2) load turn.js
      try {
        await tryUrls('turn.js', turnUrls);
      } catch (err) {
        document.getElementById('message').textContent = 'Error: turn.js failed to load from all CDNs. See diagnostics.';
        return;
      }

      // 3) load pdf.js
      try {
        const usedPdf = await tryUrls('pdf.js', pdfJsUrls);
        // set worker explicitly to help pdf.js
        if (window.pdfjsLib) {
          const worker = usedPdf.replace(/pdf(\.min)?\.js$/,'pdf.worker.min.js');
          pdfjsLib.GlobalWorkerOptions.workerSrc = worker;
          LOG('pdf.worker set to: ' + worker);
        }
      } catch (err) {
        document.getElementById('message').textContent = 'Error: pdf.js failed to load from all CDNs. See diagnostics.';
        return;
      }

      // verify turn and pdfjs present
      if (typeof $.fn.turn === 'undefined') {
        document.getElementById('message').textContent = 'Error: turn.js is loaded but $.fn.turn is undefined. See diagnostics.';
        LOG('$.fn.turn is undefined (turn.js may be incompatible).');
        return;
      }
      if (typeof pdfjsLib === 'undefined') {
        document.getElementById('message').textContent = 'Error: pdf.js is not available after load attempts.';
        LOG('pdfjsLib undefined.');
        return;
      }

      LOG('All libraries present. Initializing flipbook...');

      // === PDF rendering + turn.js initialization ===
      const url = "Norris_Mangaroo_Arch_Portfolio.pdf"; // exact filename in repo
      const flipbookEl = $('#flipbook');
      const pageCanvases = [];
      let currentZoom = 1;
      const baseRenderScale = 1.35;

      async function renderPdfToFlipbook() {
        try {
          const loadingTask = pdfjsLib.getDocument(url);
          const pdf = await loadingTask.promise;
          const total = pdf.numPages;
          $('#pageTotal').text('/ ' + total);
          $('#download').attr('href', url);

          for (let i = 1; i <= total; ++i) {
            const page = await pdf.getPage(i);
            const scale = baseRenderScale;
            const viewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            const ctx = canvas.getContext('2d');

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            pageDiv.appendChild(canvas);
            flipbookEl.append(pageDiv);
            pageCanvases.push(canvas);
          }

          // Use first page to size flipbook
          const first = pageCanvases[0];
          const flipW = Math.min(window.innerWidth * 0.88, first.width * 2 * 0.9);
          const flipH = Math.min(window.innerHeight * 0.82, first.height * 0.95);

          // initialize turn.js (two-page spread)
          flipbookEl.turn({
            width: flipW,
            height: flipH,
            autoCenter: true,
            display: 'double',
            elevation: 50,
            duration: 450
          });

          $('#prev').on('click', () => flipbookEl.turn('previous'));
          $('#next').on('click', () => flipbookEl.turn('next'));
          $('#pageNum').attr('max', total);
          $('#pageNum').on('change', function(){ const p = Math.max(1, Math.min(total, Number(this.value)||1)); flipbookEl.turn('page', p); });
          flipbookEl.bind('turned', function(e, page) { $('#pageNum').val(page); });

          function applyZoom() {
            pageCanvases.forEach(c => { c.style.transformOrigin = 'top left'; c.style.transform = 'scale(' + currentZoom + ')'; });
          }
          $('#zoomIn').on('click', function(){ currentZoom = Math.min(2.5, +(currentZoom + 0.15).toFixed(2)); applyZoom(); });
          $('#zoomOut').on('click', function(){ currentZoom = Math.max(0.6, +(currentZoom - 0.15).toFixed(2)); applyZoom(); });

          flipbookEl.turn('page', 1);
          document.getElementById('message').textContent = 'Flipbook loaded — enjoy!';
          LOG('Flipbook ready. pages=' + total);
        } catch (err) {
          document.getElementById('message').textContent = 'Error rendering PDF/flipbook. See console/diagnostics.';
          LOG('Render error: ' + (err && err.message ? err.message : err));
          console.error(err);
        }
      }

      // start rendering
      renderPdfToFlipbook();

    })();
  </script>
</body>
</html>
