<script>
  const LOG = (msg) => console.log('[flipbook] ' + msg);

  (async function main(){
    if (typeof $ === 'undefined') { document.getElementById('message').textContent = 'Error: jQuery missing.'; return; }
    if (typeof pdfjsLib === 'undefined') { document.getElementById('message').textContent = 'Error: pdf.js missing.'; return; }
    if (typeof $.fn.turn === 'undefined') { document.getElementById('message').textContent = 'Error: turn.js missing.'; return; }

    LOG('All libraries present. Rendering…');
    const url = "Norris_Mangaroo_Arch_Portfolio.pdf";
    const flipbookEl = $('#flipbook');
    const pageCanvases = [];
    let currentZoom = 1;

    try {
      const pdf = await pdfjsLib.getDocument(url).promise;
      const total = pdf.numPages;
      $('#pageTotal').text('/ ' + total);

      // Render all pages
      for (let i=1;i<=total;i++){
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({scale:1.5}); // render higher for crispness
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({canvasContext:canvas.getContext('2d'),viewport}).promise;
        const div = document.createElement('div'); div.className='page'; div.appendChild(canvas);
        flipbookEl.append(div);
        pageCanvases.push(canvas);
      }

      // Initialize turn.js with placeholder sizes
      const first = pageCanvases[0];
      flipbookEl.turn({
        width: first.width*2,
        height: first.height,
        display:'double',
        autoCenter:true,
        elevation:50,
        duration:450
      });

      // --- Fit-to-width sizing ---
      function resizeFlipbook() {
        const first = pageCanvases[0];
        if (!first) return;

        const spreadNaturalW = first.width * 2;
        const spreadNaturalH = first.height;

        const maxW = window.innerWidth * 0.9; // 90% of viewport width
        const scale = (maxW / spreadNaturalW) * currentZoom;

        const targetW = spreadNaturalW * scale;
        const targetH = spreadNaturalH * scale;

        flipbookEl.turn('size', targetW, targetH);
      }

      // Controls
      $('#prev').on('click',()=>flipbookEl.turn('previous'));
      $('#next').on('click',()=>flipbookEl.turn('next'));
      $('#pageNum').attr('max',total);
      $('#pageNum').on('change',function(){
        const p=Math.max(1,Math.min(total,+this.value||1));
        flipbookEl.turn('page',p);
      });
      flipbookEl.bind('turned',(e,p)=>$('#pageNum').val(p));

      // Zoom (affects fit-to-width scaling)
      $('#zoomIn').on('click',()=>{currentZoom=Math.min(2.5,currentZoom+0.15);resizeFlipbook();});
      $('#zoomOut').on('click',()=>{currentZoom=Math.max(0.6,currentZoom-0.15);resizeFlipbook();});

      window.addEventListener('resize', resizeFlipbook);
      resizeFlipbook();

      document.getElementById('message').textContent='Flipbook loaded — enjoy!';
    } catch(err){
      document.getElementById('message').textContent='Error rendering PDF.';
      console.error(err);
    }
  })();
</script>
